<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NyaDeskPet - 使用帮助</title>
  <script src="../node_modules/marked/lib/marked.umd.js"></script>
  <script src="lib/highlight.min.js"></script>
  <script src="../node_modules/mermaid/dist/mermaid.min.js"></script>
  <link id="hljs-theme" rel="stylesheet" href="lib/hljs-github.min.css">
  <style>
    :root {
      --bg: #ffffff;
      --text: #24292f;
      --text-secondary: #57606a;
      --border: #d0d7de;
      --code-bg: #f6f8fa;
      --link: #0969da;
      --heading-border: #d8dee4;
      --table-border: #d0d7de;
      --table-row-alt: #f6f8fa;
      --blockquote-border: #d0d7de;
      --blockquote-text: #57606a;
      --sidebar-bg: #f6f8fa;
      --sidebar-hover: #e8ecf0;
      --sidebar-active: #dce4eb;
      --alert-note-border: #0969da;
      --alert-note-icon: #0969da;
      --alert-tip-border: #1a7f37;
      --alert-tip-icon: #1a7f37;
      --alert-important-border: #8250df;
      --alert-important-icon: #8250df;
      --alert-warning-border: #9a6700;
      --alert-warning-icon: #9a6700;
      --alert-caution-border: #cf222e;
      --alert-caution-icon: #cf222e;
    }

    @media (prefers-color-scheme: dark) {
      :root:not(.light-theme) {
        --bg: #0d1117;
        --text: #e6edf3;
        --text-secondary: #8b949e;
        --border: #30363d;
        --code-bg: #161b22;
        --link: #58a6ff;
        --heading-border: #21262d;
        --table-border: #30363d;
        --table-row-alt: #161b22;
        --blockquote-border: #30363d;
        --blockquote-text: #8b949e;
        --sidebar-bg: #161b22;
        --sidebar-hover: #1c2128;
        --sidebar-active: #22272e;
        --alert-note-border: #58a6ff;
        --alert-note-icon: #58a6ff;
        --alert-tip-border: #3fb950;
        --alert-tip-icon: #3fb950;
        --alert-important-border: #a371f7;
        --alert-important-icon: #a371f7;
        --alert-warning-border: #d29922;
        --alert-warning-icon: #d29922;
        --alert-caution-border: #f85149;
        --alert-caution-icon: #f85149;
      }
    }

    .dark-theme {
      --bg: #0d1117;
      --text: #e6edf3;
      --text-secondary: #8b949e;
      --border: #30363d;
      --code-bg: #161b22;
      --link: #58a6ff;
      --heading-border: #21262d;
      --table-border: #30363d;
      --table-row-alt: #161b22;
      --blockquote-border: #30363d;
      --blockquote-text: #8b949e;
      --sidebar-bg: #161b22;
      --sidebar-hover: #1c2128;
      --sidebar-active: #22272e;
      --alert-note-border: #58a6ff;
      --alert-note-icon: #58a6ff;
      --alert-tip-border: #3fb950;
      --alert-tip-icon: #3fb950;
      --alert-important-border: #a371f7;
      --alert-important-icon: #a371f7;
      --alert-warning-border: #d29922;
      --alert-warning-icon: #d29922;
      --alert-caution-border: #f85149;
      --alert-caution-icon: #f85149;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
      font-size: 14px;
      line-height: 1.6;
      color: var(--text);
      background: var(--bg);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* ======== 侧栏 ======== */
    #sidebar {
      width: 220px;
      min-width: 220px;
      height: 100vh;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 16px 0;
      display: flex;
      flex-direction: column;
    }

    #sidebar-nav {
      flex: 1;
      padding: 0 12px;
    }

    #sidebar-nav .sidebar-title {
      font-size: 15px;
      font-weight: 700;
      padding: 4px 10px 12px;
      color: var(--text);
    }

    #sidebar-nav .sidebar-group {
      margin-bottom: 2px;
    }

    #sidebar-nav .sidebar-group-header {
      display: flex;
      align-items: center;
      padding: 6px 10px;
      margin-top: 6px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 6px;
      user-select: none;
      transition: background 0.15s, color 0.15s;
    }

    #sidebar-nav .sidebar-group-header:hover {
      background: var(--sidebar-hover);
      color: var(--text);
    }

    #sidebar-nav .sidebar-group-header .group-arrow {
      display: inline-block;
      width: 12px;
      font-size: 10px;
      margin-right: 4px;
      transition: transform 0.2s;
      color: var(--text-secondary);
    }

    #sidebar-nav .sidebar-group.collapsed .group-arrow {
      transform: rotate(-90deg);
    }

    #sidebar-nav .sidebar-group-children {
      overflow: hidden;
      transition: max-height 0.25s ease;
    }

    #sidebar-nav .sidebar-group.collapsed .sidebar-group-children {
      max-height: 0 !important;
    }

    #sidebar-nav .sidebar-link {
      display: block;
      padding: 4px 10px 4px 26px;
      margin: 1px 0;
      font-size: 13px;
      color: var(--text);
      text-decoration: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
      position: relative;
    }

    #sidebar-nav .sidebar-link::before {
      content: '';
      position: absolute;
      left: 14px;
      top: 50%;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--border);
      transform: translateY(-50%);
      transition: background 0.15s;
    }

    #sidebar-nav .sidebar-link:hover {
      background: var(--sidebar-hover);
    }

    #sidebar-nav .sidebar-link:hover::before {
      background: var(--text-secondary);
    }

    #sidebar-nav .sidebar-link.active {
      background: var(--sidebar-active);
      font-weight: 500;
      color: var(--link);
    }

    #sidebar-nav .sidebar-link.active::before {
      background: var(--link);
    }

    #sidebar-nav .sidebar-separator {
      height: 1px;
      background: var(--border);
      margin: 8px 10px;
      opacity: 0.5;
    }

    #sidebar-footer {
      padding: 8px 12px;
      border-top: 1px solid var(--border);
      margin-top: 8px;
    }

    #sidebar-footer select {
      width: 100%;
      padding: 4px 8px;
      font-size: 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      color: var(--text);
      cursor: pointer;
      outline: none;
    }

    /* ======== 主内容 ======== */
    #main {
      flex: 1;
      overflow-y: auto;
      height: 100vh;
    }

    #content {
      max-width: 820px;
      margin: 0 auto;
      padding: 32px 24px 64px;
    }

    #loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Markdown 样式 */
    #content h1 {
      font-size: 24px;
      font-weight: 600;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--heading-border);
      margin-bottom: 16px;
    }

    #content h2 {
      font-size: 20px;
      font-weight: 600;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--heading-border);
      margin-top: 28px;
      margin-bottom: 12px;
    }

    #content h3 {
      font-size: 16px;
      font-weight: 600;
      margin-top: 24px;
      margin-bottom: 8px;
    }

    #content h4 {
      font-size: 14px;
      font-weight: 600;
      margin-top: 20px;
      margin-bottom: 6px;
    }

    #content p {
      margin-bottom: 12px;
    }

    #content a {
      color: var(--link);
      text-decoration: none;
    }

    #content a:hover {
      text-decoration: underline;
    }

    #content code {
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 12px;
      padding: 2px 6px;
      background: var(--code-bg);
      border-radius: 4px;
    }

    #content pre {
      background: var(--code-bg);
      padding: 14px 16px;
      border-radius: 6px;
      overflow-x: auto;
      margin-bottom: 14px;
      border: 1px solid var(--border);
    }

    #content pre code {
      padding: 0;
      background: none;
      font-size: 12px;
      line-height: 1.5;
    }

    #content pre code.hljs {
      background: transparent;
      padding: 0;
    }

    /* mermaid diagram container */
    #content pre.mermaid-wrapper {
      background: transparent;
      border: none;
      padding: 0;
      text-align: center;
      overflow-x: auto;
    }

    #content .mermaid {
      background: transparent;
    }

    #content .mermaid svg {
      max-width: 100%;
    }

    #content ul, #content ol {
      padding-left: 24px;
      margin-bottom: 12px;
    }

    #content li {
      margin-bottom: 4px;
    }

    #content li > ul, #content li > ol {
      margin-top: 4px;
      margin-bottom: 0;
    }

    #content table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 14px;
      font-size: 13px;
    }

    #content th, #content td {
      padding: 8px 12px;
      border: 1px solid var(--table-border);
      text-align: left;
    }

    #content th {
      font-weight: 600;
      background: var(--code-bg);
    }

    #content tr:nth-child(even) {
      background: var(--table-row-alt);
    }

    #content blockquote {
      padding: 8px 16px;
      margin-bottom: 12px;
      border-left: 3px solid var(--blockquote-border);
      color: var(--blockquote-text);
    }

    #content blockquote p {
      margin-bottom: 0;
    }

    /* GitHub-style alert blocks */
    #content .markdown-alert {
      padding: 8px 16px;
      margin-bottom: 12px;
      border-left: 3px solid;
      border-radius: 0 6px 6px 0;
    }

    #content .markdown-alert .markdown-alert-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
    }

    #content .markdown-alert .markdown-alert-title svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    #content .markdown-alert p {
      margin-bottom: 0;
    }

    #content .markdown-alert-note {
      border-left-color: var(--alert-note-border);
      background: color-mix(in srgb, var(--alert-note-border) 8%, transparent);
    }
    #content .markdown-alert-note .markdown-alert-title { color: var(--alert-note-icon); }

    #content .markdown-alert-tip {
      border-left-color: var(--alert-tip-border);
      background: color-mix(in srgb, var(--alert-tip-border) 8%, transparent);
    }
    #content .markdown-alert-tip .markdown-alert-title { color: var(--alert-tip-icon); }

    #content .markdown-alert-important {
      border-left-color: var(--alert-important-border);
      background: color-mix(in srgb, var(--alert-important-border) 8%, transparent);
    }
    #content .markdown-alert-important .markdown-alert-title { color: var(--alert-important-icon); }

    #content .markdown-alert-warning {
      border-left-color: var(--alert-warning-border);
      background: color-mix(in srgb, var(--alert-warning-border) 8%, transparent);
    }
    #content .markdown-alert-warning .markdown-alert-title { color: var(--alert-warning-icon); }

    #content .markdown-alert-caution {
      border-left-color: var(--alert-caution-border);
      background: color-mix(in srgb, var(--alert-caution-border) 8%, transparent);
    }
    #content .markdown-alert-caution .markdown-alert-title { color: var(--alert-caution-icon); }

    #content hr {
      border: none;
      border-top: 1px solid var(--heading-border);
      margin: 24px 0;
    }

    #content img {
      max-width: 100%;
      border-radius: 6px;
    }

    /* 文档页内目录 */
    #content > ul:first-of-type {
      background: var(--code-bg);
      padding: 14px 14px 14px 32px;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }

    #content > ul:first-of-type a {
      font-size: 13px;
    }
  </style>
</head>
<body>
  <!-- 侧栏导航 -->
  <aside id="sidebar">
    <nav id="sidebar-nav"></nav>
    <div id="sidebar-footer">
      <select id="locale-select">
        <option value="zh-CN">简体中文</option>
        <option value="en-US">English</option>
      </select>
    </div>
  </aside>

  <!-- 主内容区 -->
  <main id="main">
    <div id="loading">加载中...</div>
    <div id="content" style="display: none;"></div>
  </main>

  <script>
    // ======== 常量 ========
    const DOCS_BASE = '../assets/docs';
    const DEFAULT_DOC = 'README.md';
    const DEFAULT_LOCALE = 'zh-CN';

    // ======== 状态 ========
    let currentLocale = DEFAULT_LOCALE;
    let currentDoc = DEFAULT_DOC;

    // ======== 初始化 ========
    (function initTheme() {
      const params = new URLSearchParams(window.location.search);
      const theme = params.get('theme');
      if (theme === 'dark') {
        document.documentElement.classList.add('dark-theme');
      } else if (theme === 'light') {
        document.documentElement.classList.add('light-theme');
      }

      // 从 URL 参数读取 locale
      const locale = params.get('locale');
      if (locale && (locale === 'zh-CN' || locale === 'en-US')) {
        currentLocale = locale;
      }

      // 切换 highlight.js 主题
      const isDark = theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches);
      document.getElementById('hljs-theme').href = isDark
        ? 'lib/hljs-github-dark.min.css'
        : 'lib/hljs-github.min.css';

      // 初始化 mermaid（延迟渲染，手动触发）
      mermaid.initialize({
        startOnLoad: false,
        theme: isDark ? 'dark' : 'default',
        securityLevel: 'strict',
      });
    })();

    // ======== 文档路径解析 ========
    // 当前文档的基础路径（用于解析图片等相对路径）
    let currentDocBase = DOCS_BASE;

    function resolveDocUrl(docName) {
      if (currentLocale === DEFAULT_LOCALE) {
        return `${DOCS_BASE}/${docName}`;
      }
      // 非默认语言：先尝试翻译版，不存在时回退默认
      return `${DOCS_BASE}/${currentLocale}/${docName}`;
    }

    function resolveImageSrc(href) {
      // 绝对路径或外部 URL 不变
      if (/^(https?:\/\/|data:|\/)/.test(href)) return href;
      // 相对路径: 基于当前文档所在目录解析
      if (href.startsWith('./')) href = href.slice(2);
      return `${currentDocBase}/${href}`;
    }

    function resolveSidebarUrl() {
      if (currentLocale === DEFAULT_LOCALE) {
        return `${DOCS_BASE}/_sidebar.md`;
      }
      return `${DOCS_BASE}/${currentLocale}/_sidebar.md`;
    }

    // ======== 侧栏解析与渲染 ========
    function parseSidebar(mdText) {
      // 解析 _sidebar.md 为层级结构
      // 支持: - **Group Title** 顶层分组 (含子项 - [link])
      //        - [Label](file.md)  子项链接
      const groups = [];
      let currentGroup = null;
      const lines = mdText.split('\n');

      for (const line of lines) {
        const trimmed = line.trimEnd();
        if (!trimmed || trimmed.startsWith('<!--')) continue;

        const indent = line.search(/\S/);

        // 顶层粗体分组: "- **Title**"
        const boldMatch = trimmed.match(/^-\s+\*\*(.+?)\*\*/);
        if (boldMatch && indent === 0) {
          currentGroup = { type: 'group', label: boldMatch[1], children: [] };
          groups.push(currentGroup);
          continue;
        }

        // 缩进链接: "  - [Label](file.md)"
        const linkMatch = trimmed.match(/^\s*-\s+\[(.+?)\]\((.+?)\)/);
        if (linkMatch) {
          const item = { type: 'link', label: linkMatch[1], href: linkMatch[2] };
          if (currentGroup && indent > 0) {
            currentGroup.children.push(item);
          } else {
            groups.push(item);
          }
          continue;
        }

        // 顶层普通分类: "- Category"
        const catMatch = trimmed.match(/^-\s+(.+)/);
        if (catMatch && indent === 0) {
          currentGroup = { type: 'group', label: catMatch[1], children: [] };
          groups.push(currentGroup);
          continue;
        }
      }
      return groups;
    }

    function renderSidebar(items) {
      const nav = document.getElementById('sidebar-nav');
      nav.innerHTML = '';

      let isFirst = true;
      for (const item of items) {
        if (item.type === 'group') {
          // 第一个分组作为标题，不可折叠
          if (isFirst && item.children.length === 0) {
            const el = document.createElement('div');
            el.className = 'sidebar-title';
            el.textContent = item.label;
            nav.appendChild(el);
            isFirst = false;
            continue;
          }
          isFirst = false;

          const group = document.createElement('div');
          group.className = 'sidebar-group';

          // 分组头 (可折叠)
          const header = document.createElement('div');
          header.className = 'sidebar-group-header';

          const arrow = document.createElement('span');
          arrow.className = 'group-arrow';
          arrow.textContent = '▼';
          header.appendChild(arrow);

          const labelSpan = document.createElement('span');
          labelSpan.textContent = item.label;
          header.appendChild(labelSpan);

          header.addEventListener('click', () => {
            group.classList.toggle('collapsed');
          });

          group.appendChild(header);

          // 子项容器
          if (item.children.length > 0) {
            const childrenEl = document.createElement('div');
            childrenEl.className = 'sidebar-group-children';

            for (const child of item.children) {
              if (child.type === 'link') {
                const el = document.createElement('a');
                el.className = 'sidebar-link';
                el.textContent = child.label;
                el.dataset.doc = child.href;
                if (child.href === currentDoc) el.classList.add('active');
                el.addEventListener('click', (e) => {
                  e.preventDefault();
                  navigateTo(child.href);
                });
                childrenEl.appendChild(el);
              }
            }

            group.appendChild(childrenEl);

            // 计算初始展开高度
            requestAnimationFrame(() => {
              childrenEl.style.maxHeight = childrenEl.scrollHeight + 'px';
            });
          }

          nav.appendChild(group);
        } else if (item.type === 'link') {
          // 顶层链接（无分组）
          const el = document.createElement('a');
          el.className = 'sidebar-link';
          el.style.paddingLeft = '10px';
          el.textContent = item.label;
          el.dataset.doc = item.href;
          if (item.href === currentDoc) el.classList.add('active');
          el.addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo(item.href);
          });
          nav.appendChild(el);
        }
      }
    }

    function updateActiveLink() {
      document.querySelectorAll('.sidebar-link').forEach(el => {
        el.classList.toggle('active', el.dataset.doc === currentDoc);
      });
    }

    // ======== GitHub Alert Blocks ========
    const ALERT_ICONS = {
      NOTE: '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>',
      TIP: '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>',
      IMPORTANT: '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>',
      WARNING: '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>',
      CAUTION: '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>'
    };

    const ALERT_LABELS = {
      'zh-CN': { NOTE: '备注', TIP: '提示', IMPORTANT: '重要', WARNING: '警告', CAUTION: '注意' },
      'en-US': { NOTE: 'Note', TIP: 'Tip', IMPORTANT: 'Important', WARNING: 'Warning', CAUTION: 'Caution' }
    };

    // ======== Mermaid 渲染 ========
    let mermaidCounter = 0;
    async function renderMermaidBlocks(container) {
      const mermaidBlocks = container.querySelectorAll('pre code.language-mermaid');
      for (const block of mermaidBlocks) {
        const pre = block.parentElement;
        const code = block.textContent || '';
        const id = `mermaid-${++mermaidCounter}`;

        try {
          const { svg } = await mermaid.render(id, code);
          const wrapper = document.createElement('pre');
          wrapper.className = 'mermaid-wrapper';
          const div = document.createElement('div');
          div.className = 'mermaid';
          div.innerHTML = svg;
          wrapper.appendChild(div);
          pre.replaceWith(wrapper);
        } catch (err) {
          console.error('Mermaid render error:', err);
          // 渲染失败时保留原始代码块
          pre.style.borderColor = 'var(--alert-caution-border)';
        }
      }
    }

    function processAlertBlocks(container) {
      container.querySelectorAll('blockquote').forEach(bq => {
        const firstP = bq.querySelector('p');
        if (!firstP) return;

        // 检测 [!TYPE] 格式（可能在 <strong> 中、带 emoji 前缀，或直接文本）
        const html = firstP.innerHTML;
        const match = html.match(/^\s*(?:<strong>)?\[!(NOTE|TIP|IMPORTANT|WARNING|CAUTION)\](?:<\/strong>)?\s*<br\s*\/?>\s*/i)
                   || html.match(/^\s*(?:<strong>)?\[!(NOTE|TIP|IMPORTANT|WARNING|CAUTION)\](?:<\/strong>)?\s*/i);
        if (!match) return;

        const type = match[1].toUpperCase();
        const labels = ALERT_LABELS[currentLocale] || ALERT_LABELS['zh-CN'];
        const icon = ALERT_ICONS[type] || '';
        const label = labels[type] || type;

        // 移除匹配到的 [!TYPE] 标记
        firstP.innerHTML = html.slice(match[0].length);
        if (!firstP.innerHTML.trim()) firstP.remove();

        // 转换为 alert block
        bq.className = `markdown-alert markdown-alert-${type.toLowerCase()}`;
        const title = document.createElement('p');
        title.className = 'markdown-alert-title';
        title.innerHTML = `${icon}<span>${label}</span>`;
        bq.insertBefore(title, bq.firstChild);
      });
    }

    // ======== 文档加载 ========
    async function loadDocument(docName) {
      const content = document.getElementById('content');
      const loading = document.getElementById('loading');

      content.style.display = 'none';
      loading.style.display = 'flex';
      loading.textContent = currentLocale === 'zh-CN' ? '加载中...' : 'Loading...';

      try {
        let url = resolveDocUrl(docName);
        let resp = await fetch(url);

        // 非默认语言文件不存在时，回退到默认语言
        if (!resp.ok && currentLocale !== DEFAULT_LOCALE) {
          url = `${DOCS_BASE}/${docName}`;
          resp = await fetch(url);
        }

        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

        // 记录实际加载的文档基础路径（用于图片相对路径解析）
        const actualUrl = resp.url || url;
        currentDocBase = actualUrl.substring(0, actualUrl.lastIndexOf('/'));

        const md = await resp.text();
        const html = marked.parse(md);
        content.innerHTML = html;

        // 代码高亮
        content.querySelectorAll('pre code').forEach(block => {
          // 跳过 mermaid 代码块（后续单独处理）
          if (block.classList.contains('language-mermaid')) return;
          hljs.highlightElement(block);
        });

        // 渲染 mermaid 图表
        await renderMermaidBlocks(content);

        // 修正所有图片的 src 路径
        content.querySelectorAll('img').forEach(img => {
          const src = img.getAttribute('src');
          if (src) img.src = resolveImageSrc(src);
        });

        // 修正所有链接中引用的文档
        content.querySelectorAll('a').forEach(a => {
          const href = a.getAttribute('href');
          if (href && !href.startsWith('http') && !href.startsWith('#') && href.endsWith('.md')) {
            a.addEventListener('click', (e) => {
              e.preventDefault();
              navigateTo(href);
            });
          }
        });

        // 解析 GitHub-style alert blocks
        processAlertBlocks(content);

        content.style.display = 'block';
        loading.style.display = 'none';

        // 滚动到顶部
        document.getElementById('main').scrollTop = 0;
      } catch (err) {
        loading.textContent = (currentLocale === 'zh-CN'
          ? '加载文档失败: '
          : 'Failed to load document: ') + err.message;
      }
    }

    async function loadSidebar() {
      try {
        let url = resolveSidebarUrl();
        let resp = await fetch(url);

        // 侧栏不存在时回退默认语言
        if (!resp.ok && currentLocale !== DEFAULT_LOCALE) {
          url = `${DOCS_BASE}/_sidebar.md`;
          resp = await fetch(url);
        }

        if (!resp.ok) throw new Error(`Sidebar HTTP ${resp.status}`);
        const md = await resp.text();
        const items = parseSidebar(md);
        renderSidebar(items);
      } catch (err) {
        console.error('Failed to load sidebar:', err);
      }
    }

    function navigateTo(docName) {
      currentDoc = docName;
      updateActiveLink();
      loadDocument(docName);
    }

    // ======== 语言切换 ========
    document.getElementById('locale-select').addEventListener('change', async (e) => {
      currentLocale = e.target.value;
      await loadSidebar();
      await loadDocument(currentDoc);
    });

    // ======== 启动 ========
    (async function init() {
      // 设置语言选择器初始值
      document.getElementById('locale-select').value = currentLocale;

      await loadSidebar();
      await loadDocument(currentDoc);
    })();
  </script>
</body>
</html>
