# 使用指南

本文档介绍 NyaDeskPet 的安装、配置和使用方法。

## 安装

### 环境要求

- Node.js 16.0 或更高版本
- npm 或 yarn 包管理器

### 安装依赖

```bash
npm install
```

## 运行

### 编译

在运行前需要编译 TypeScript 代码：

```bash
npm run compile
```

### 开发模式

```bash
npm run dev
```

开发模式特性：
- 窗口可调整大小
- 显示在任务栏
- 适合调试和开发

### 生产模式

```bash
npm start
```

生产模式特性：
- 无边框透明窗口
- 窗口置顶显示
- 系统托盘支持
- 关闭窗口时隐藏到托盘

### 自动编译

开发时可以开启监听模式：

```bash
# 终端 1：监听并自动编译
npm run watch

# 终端 2：运行应用
npm run dev
```

## 打包

### Windows

```bash
npm run build:win
```

生成文件位于 `dist/NyaDeskPet-win32-x64/`

### macOS

```bash
npm run build:mac
```

生成文件位于 `dist/NyaDeskPet-darwin-x64/`

### Linux

```bash
npm run build:linux
```

生成文件位于 `dist/NyaDeskPet-linux-x64/`

## 配置

### 图形化设置

NyaDeskPet 提供了现代化的分组设置界面，可以方便地管理各项配置。

**打开设置**：点击窗口顶栏右侧的 ⚙️ 按钮

**打开插件管理**：点击窗口顶栏的 🧩 按钮，或通过系统托盘菜单选择「插件管理」

**设置分类**：

#### 插件管理

**访问方式**：
- 点击顶栏 🧩 按钮
- 系统托盘菜单 → 插件管理

**功能**：
- **启动/停止插件**：管理插件进程的生命周期
- **连接/断开**：控制 WebSocket 连接状态
- **打开目录**：直接访问插件文件夹
- **插件配置**：图形化配置界面，每个插件可自定义配置项
- **权限管理**：查看和管理插件权限记录

**插件配置系统**：

插件可以定义配置项，用户通过图形界面修改：

1. **支持的配置类型**：
   - `string`: 单行文本输入
   - `text`: 多行文本输入
   - `int`: 整数输入（带范围限制）
   - `float`: 浮点数输入（带范围限制）
   - `bool`: 开关按钮
   - `object`: 嵌套配置对象
   - `list`: 字符串列表
   - `dict`: 键值对列表
   - `template_list`: 模板化列表（支持多字段）

2. **配置文件位置**：
   - 定义：`plugins/{plugin-name}/config.json`
   - 存储：`userData/plugins/{plugin-id}/config.json`

3. **配置流程**：
   - 点击插件卡片的 ⚙️ 按钮打开配置对话框
   - 修改配置项
   - 点击「保存」按钮
   - 配置立即保存并在插件重启后生效

**权限管理系统**：

插件执行危险操作前需要用户确认：

1. **危险等级**：
   - `safe`（安全）：无风险操作，自动允许
   - `low`（低危）：低风险操作，首次确认
   - `medium`（中危）：中等风险，每次确认
   - `high`（高危）：高风险操作，显著警告
   - `critical`（严重）：极度危险，强调警告

2. **权限确认流程**：
   - 插件请求权限 → 前端显示确认对话框
   - 用户选择「允许」或「拒绝」
   - 可选「记住选择」避免重复确认
   - 权限记录保存在 `userData/plugin-permissions.json`

3. **权限管理**：
   - 在插件管理面板查看已授予的权限
   - 可以撤销特定插件的权限记录
   - 清除后下次操作重新确认

**内置插件**：

1. **终端控制插件** (`terminal-plugin`)：
   - 执行系统命令
   - 创建和管理 Shell 会话
   - 配置项：默认 Shell、命令超时、会话数量限制、危险命令列表等
   - 权限：`terminal.execute`, `terminal.session`

2. **UI 自动化插件** (`ui-automation-plugin`)：
   - 鼠标键盘控制
   - 屏幕截图
   - 配置项：点击延迟、输入速度、截图格式、安全模式等
   - 权限：`ui-automation.mouse`, `ui-automation.keyboard`, `ui-automation.screen`

**设置分类**：

- **模型 (Model)**: Live2D 模型配置文件路径、触碰反应配置
- **连接 (Connection)**: 后端服务器地址 (HTTP/WebSocket)、自动连接开关、音频音量调节
- **角色 (Character)**: 自定义桌宠名称和人设描述，用于调整 AI 对话风格
- **显示 (Display)**: 语言选择（中文/英文）、主题切换（浅色/深色/跟随系统）、对话字幕显示控制
- **关于 (About)**: 版本信息、更新检查、GitHub 更新源配置

**保存与应用**：
- 修改设置后，部分选项会立即生效（如主题、语言、滚轮缩放状态）
- 网络地址等核心设置需要保存并重新启动/刷新应用
- 设置自动持久化存储在本地 localStorage
- 点击"恢复默认"按钮可重置所有设置

### 手动配置

如需手动编辑配置，可修改 `renderer/js/settings-manager.ts` 中的 `defaultSettings`：

```typescript
private defaultSettings: AppSettings = {
  modelPath: 'models/default/model3.json',
  backendUrl: 'http://localhost:8000',
  wsUrl: 'ws://localhost:8000/ws',
  autoConnect: true,
  volume: 0.8
};
```

### Live2D 模型配置

**方式 1: 使用设置面板（推荐）**

1. 点击窗口右上角的 ⚙️ 按钮打开设置
2. 在"模型"标签页修改模型路径
3. 保存并重新加载应用

**方式 2: 手动放置模型文件**

1. 将 Live2D 模型文件夹放入 `models/` 目录
2. 模型结构示例：

```
models/
└── your-model/
    ├── model3.json          # 模型配置
    ├── *.moc3               # 模型数据
    ├── *.physics3.json      # 物理配置
    ├── motions/             # 动作文件
    ├── expressions/         # 表情文件
    └── textures/            # 纹理图片
```

3. 在设置中修改模型路径为 `models/your-model/model3.json`

### 语音识别配置

NyaDeskPet 支持使用 Sherpa-ONNX 框架进行本地语音识别。

**安装 FFmpeg（必需）**

FFmpeg 用于音频格式转换：

- **macOS**: `brew install ffmpeg`
- **Ubuntu/Debian**: `sudo apt install ffmpeg`
- **Windows**: 从 [FFmpeg 官网](https://ffmpeg.org/download.html) 下载并添加到环境变量

验证安装：`ffmpeg -version`

**下载语音识别模型**

模型：Sherpa-ONNX Sense-Voice-Small（支持中英日韩粤语）

方式 1 - Hugging Face：
```
https://huggingface.co/csukuangfj/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17
```

下载以下文件到 `models/asr/sense-voice-small/` 目录：
- `model.onnx` - 主模型文件（约 200MB）
- `tokens.txt` - 词表文件

方式 2 - 命令行：

```bash
# 安装 Hugging Face CLI
pip install huggingface-hub

# 下载模型
huggingface-cli download csukuangfj/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17 \
  --local-dir models/asr/sense-voice-small
```

方式 3 - GitHub Release：访问 [Sherpa-ONNX Releases](https://github.com/k2-fsa/sherpa-onnx/releases) 搜索 "sense-voice" 相关模型包。

**验证安装**

启动应用后，查看日志：
- 成功：`[ASR] 初始化成功` 和 `ASR 服务初始化成功`
- 失败：`[ASR] 模型文件不存在` 和 `ASR 服务初始化失败，语音识别功能将不可用`

**麦克风设置**

在设置面板 > 连接标签页配置：
- **背景模式**: 启用后，未打开对话窗口也可录音
- **音量阈值**: 麦克风录音触发阈值（0-100）
- **自动发送**: 识别后自动发送或填充到输入框

**使用语音识别**

1. 点击聊天输入框旁的 🎤 按钮开始录音
2. 对着麦克风说话（音量需高于阈值）
3. 静音 1.5 秒后自动停止录音并识别
4. 识别结果会自动发送或填充到输入框

### 应用图标配置

将图标文件放入 `assets/` 目录：

- **icon.ico** - Windows 图标（推荐 16×16 到 256×256）
- **icon.icns** - macOS 图标（推荐 16×16 到 1024×1024）
- **icon.png** - Linux 图标（推荐 512×512 或 1024×1024）

可使用在线工具生成：https://www.icoconverter.com/

## 使用

### 基础操作

**启动应用**：运行 `npm start` 或双击可执行文件

**交互操作**：
- **滚轮缩放**：在模型显示区域滚动鼠标滚轮，可调整模型大小（0.3x - 3.0x）
- **点击反馈**：点击模型不同部位（头部、身体等）触发对应的动作、表情和消息
- **视线跟随**：模型头部和眼睛会跟随鼠标指针移动
- **窗口移动**：拖拽顶栏区域移动窗口
- **UI 切换**：双击模型或点击右上角按钮切换"完整 UI"和"纯模型"模式

### 触碰交互

模型支持多种触碰反应，点击不同部位会发送触摸信息给后端 Agent：

- **头部 (Head)**: 触摸头部
- **身体 (Body)**: 触摸身体
- **嘴部 (Mouth)**: 触摸嘴部
- **其他区域**: 触摸其他区域

**配置触碰反应**（设置面板 > 模型 > 触碰反应配置）：
- 可启用/禁用特定部位的触摸反应
- 取消勾选可禁用某个部位的触摸事件发送
- 每个模型有独立的触碰配置，自动持久化存储
- 触摸反应的具体行为（动作、表情、消息）由后端 Agent 决定

### 侧边栏聊天

对话界面已由旧版的居中浮窗改为侧边栏设计：

1. **打开对话** - 点击顶栏图标或在托盘菜单选择“对话”。
2. **发送消息** - 在输入框输入文本并回车。
3. **对话历史** - 侧边栏支持查看与 AI 的历史对话内容。
4. **字幕显示** - 如果在设置中开启了“显示对话字幕”，在聊天框关闭时，底部仍会浮现简短的对话文字
5. **口型同步** - 后端返回语音消息时，模型会根据音频频率自动进行口型同步动画，使对话更加自然生动。

### 窗口布局

应用窗口分为三个主要区域：

1. **顶栏（可拖拽）**
   - 左侧：连接状态指示器。
   - 右侧：切换模式、设置、最小化、关闭按钮。
   - **重要**：只有拖动顶栏才能移动整个窗口。

2. **主内容区域（模型渲染区）**
   - 显示 Live2D 模型。
   - 支持点击交互、视线跟随、鼠标滚轮缩放。
   - 模型会自动适应窗口大小的变化。

3. **侧滑对话栏**
   - 点击相关按钮滑出。
   - 集成对话记录沉浸式对话、输入框以及后续的多模态功能。

### 系统托盘

应用在生产模式下提供系统托盘支持：

**托盘图标**：应用最小化或隐藏后显示在系统托盘

**托盘菜单**（右键点击，macOS 单击）：
- **显示宠物/隐藏宠物**：切换窗口可见性
- **显示 UI/隐藏 UI**：切换 UI 显示模式（纯模型或完整 UI）
- **打开对话/关闭对话**：切换对话窗口
- **置顶显示**：切换窗口是否始终置顶
- **设置**：打开设置面板
- **退出**：完全退出应用

菜单按钮文字根据当前状态动态更新。

**快捷操作**：双击托盘图标可快速显示/隐藏窗口

**关闭行为**：点击窗口关闭按钮时，应用不会退出，而是隐藏到托盘

**自定义托盘图标**：
- `assets/tray-icon-mac.png`：macOS 托盘图标（16×16 或 32×32，黑白单色）
- `assets/tray-icon.png`：Windows/Linux 托盘图标（16×16 或 32×32）

### UI 显示模式

应用支持两种显示模式：

**完整 UI 模式**（默认）：
- 显示顶栏（状态+控制按钮）
- 显示底栏（对话按钮）
- 适合日常使用和操作

**纯模型模式**：
- 隐藏所有 UI 元素
- 仅显示 Live2D 模型
- 更加沉浸，适合观赏

**切换方式**：
- 点击右下角 UI 切换按钮（眼睛图标）
- 双击模型快速切换
- 使用系统托盘菜单 → "显示/隐藏 UI"

注意：隐藏 UI 后，切换按钮会移至更低位置，保持可访问性。

### 窗口控制

- **顶栏拖动**：拖动顶栏移动整个窗口
- **窗口调整**：所有模式下均支持调整窗口大小（最小 300×400）
- **最小化**：点击顶栏右侧 `━` 按钮
- **关闭/隐藏**：点击顶栏右侧 `✕` 按钮（生产模式下隐藏到托盘）
- **设置**：点击顶栏右侧 `⚙️` 按钮
- **对话**：点击底栏右下角 `💬` 按钮

## 交互操作

### 基本操作

- **拖动窗口**：拖拽顶栏区域
- **最小化**：点击顶栏 `-` 按钮或托盘菜单「隐藏宠物」
- **关闭**：点击顶栏 `✕` 按钮（应用会最小化到托盘）
- **彻底退出**：右键托盘图标选择「退出」
- **设置**：点击顶栏 ⚙️ 按钮或托盘菜单「设置」
- **插件管理**：点击顶栏 🧩 按钮或托盘菜单「插件管理」
- **对话**：点击底栏右下角 `💬` 按钮

### 插件系统

NyaDeskPet 支持通过插件扩展功能。插件独立运行，通过 WebSocket 与应用通信。

**管理插件**：
1. 点击顶栏 🧩 按钮或托盘菜单打开插件管理面板
2. 查看已安装的插件列表及其状态
3. 点击「启动」按钮启动插件进程
4. 启动成功后点击「连接」建立 WebSocket 连接
5. 连接成功后插件功能即可使用

**内置插件**：
- **终端控制插件**（`terminal-plugin`）：执行系统命令、管理 Shell 会话
- **UI 自动化插件**（`ui-automation-plugin`）：模拟鼠标键盘操作、截图等

**插件配置**：
每个插件目录下的 `metadata.json` 定义了插件的元信息和启动命令：
```json
{
  "command": {
    "darwin": ["venv/bin/python3", "main.py"],
    "win32": ["venv\\Scripts\\python.exe", "main.py"]
  },
  "workingDirectory": "plugins/terminal-plugin",
  "autoStart": false
}
```

**插件开发**：详见 [docs/API.md](API.md#外置插件协议)

### 调试

使用浏览器开发者工具调试：

```javascript
// 发送消息
window.app.sendMessage('你好');

// 显示对话
window.app.showDialogue('测试对话', 3000);

// 播放动作
window.app.playMotion('TapBody', 0);

// 设置表情
window.app.setExpression('smile');

// 查看应用状态
window.app.getState();
```

## 常见问题

### 模型无法加载

**解决方案**：
1. 检查模型文件路径是否正确
2. 确认模型文件完整且格式正确
3. 查看控制台的错误信息
4. 尝试使用官方示例模型测试

### 后端连接失败

**解决方案**：
1. 确认后端服务器已启动
2. 检查设置中的后端 URL 是否正确
3. 检查网络连接是否正常
4. 查看浏览器控制台的错误信息

### 窗口无法拖拽

**解决方案**：只能拖拽顶栏区域移动窗口，模型区域不支持拖拽

### 语音识别不工作

**解决方案**：
1. 确认 FFmpeg 已安装
2. 检查模型文件是否存在
3. 查看控制台 ASR 初始化日志
4. 确认麦克风权限已授予
5. 调整音量阈值设置

### 清除缓存

手动清除浏览器数据（使用开发者工具）：
1. 按 F12 或右键→检查元素打开开发者工具
2. Application → Storage → Clear site data

## 更新

### 更新应用

```bash
# 拉取最新代码
git pull

# 安装依赖（如有新依赖）
npm install

# 重新编译
npm run compile
```