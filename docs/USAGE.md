# 使用指南

本文档介绍如何安装、配置和使用 NyaDeskPet。

## 📦 安装

### 前置要求
- Node.js 16.0 或更高版本
- npm 或 yarn 包管理器

### 安装依赖

```bash
npm install
```

---

## 🚀 运行

### 编译 TypeScript

在运行前，需要先编译 TypeScript 代码：

```bash
npm run compile
```

### 开发模式

```bash
npm run dev
```

开发模式特性：
- 自动打开开发者工具
- 窗口可调整大小
- 显示在任务栏
- 适合调试和开发

### 生产模式

```bash
npm start
```

生产模式特性：
- 无边框透明窗口
- 窗口置顶显示
- 系统托盘支持
- 关闭窗口时隐藏到托盘（不退出）

### 自动编译（监听模式）

打开两个终端进行开发：

```bash
# 终端 1：监听并自动编译
npm run watch

# 终端 2：运行应用
npm run dev
```

---

## 📦 打包

### Windows

```bash
npm run build:win
```

生成文件位于 `dist/NyaDeskPet-win32-x64/`

### macOS

```bash
npm run build:mac
```

生成文件位于 `dist/NyaDeskPet-darwin-x64/`

### Linux

```bash
npm run build:linux
```

生成文件位于 `dist/NyaDeskPet-linux-x64/`

---

## ⚙️ 配置

### 图形化设置

NyaDeskPet 提供了现代化的分组设置界面（v1.3），可以方便地管理各项配置：

1. **打开设置面板**
   - 点击窗口顶栏右侧的 ⚙️ 按钮。

2. **设置标签页分类**
   - **模型 (Model)**：Live2D 模型配置文件路径、触碰反应配置。
   - **连接 (Connection)**：后端服务器地址 (HTTP/WebSocket)、自动连接开关、音频音量调节。
   - **角色 (Character)** (v1.5)：自定义桌宠名称和人设描述，用于调整 AI 对话风格。
   - **显示 (Display)**：语言选择（中文/英文）、主题切换（浅色/深色/跟随系统）、对话字幕显示控制。
   - **关于 (About)**：版本信息、更新检查、GitHub 更新源配置。

3. **保存与应用**
   - 修改设置后，部分选项会立即生效（如主题、语言、滚轮缩放状态）。
   - 网络地址等核心设置需要保存并重新启动/刷新应用。
   - 设置自动持久化存储在本地 localStorage。

4. **恢复默认**
   - 点击"恢复默认"按钮可重置所有设置。

### 手动配置（高级）

如果需要手动编辑配置文件，可以编辑 [renderer/js/settings-manager.ts](renderer/js/settings-manager.ts) 中的 `defaultSettings`：

```typescript
private defaultSettings: AppSettings = {
  modelPath: 'models/default/model3.json',
  backendUrl: 'http://localhost:8000',
  wsUrl: 'ws://localhost:8000/ws',
  autoConnect: true,
  volume: 0.8
};
```

### Live2D 模型配置

您可以通过两种方式配置 Live2D 模型：

**方式 1: 使用设置面板（推荐）**
1. 点击窗口右上角的 ⚙️ 按钮打开设置
2. 在"Live2D 模型"部分修改模型路径
3. 保存并重新加载应用

**方式 2: 手动放置模型文件**

1. 将 Live2D 模型文件夹放入 `models/` 目录
2. 模型结构示例：

```
models/
└── your-model/
    ├── model3.json          # 模型配置
    ├── *.moc3               # 模型数据
    ├── *.physics3.json      # 物理配置
    ├── motions/             # 动作文件
    ├── expressions/         # 表情文件
    └── textures/            # 纹理图片
```

3. 修改 `APP_CONFIG.modelPath` 为模型路径

### 应用图标配置

将图标文件放入 `assets/` 目录：

- **icon.ico** - Windows 图标（推荐 16×16 到 256×256）
- **icon.icns** - macOS 图标（推荐 16×16 到 1024×1024）
- **icon.png** - Linux 图标（推荐 512×512 或 1024×1024）

可使用在线工具生成：https://www.icoconverter.com/

---

## 🎮 使用说明

### 基础操作

1. **启动应用** - 运行 `npm start` 或双击可执行文件。
2. **模型加载** - 应用启动后自动加载配置的 Live2D 模型。
3. **交互操作**：
   - **滚轮缩放**：在模型显示区域滚动鼠标中键，可自由调整模型大小（范围 0.3x - 3.0x）。
   - **点击反馈**：点击模型不同部位（头部、身体等）触发对应的动作、表情和消息。
   - **视线跟随**：模型头部和眼睛会跟随鼠标指针移动。
4. **窗口移动** - 只有拖拽**顶栏**区域可以移动窗口。
5. **UI 切换** - 双击模型或点击右上角的矩形图标切换"完整 UI"和"纯模型"模式。

### 触碰交互 (v1.4)

模型支持多种触碰反应，点击不同部位会将触摸信息发送给后端Agent：
- **头部 (Head)**: 触摸头部，后端可能返回抚摸动作和开心表情。
- **身体 (Body)**: 触摸身体，后端可能返回躲避或撒娇动作。
- **嘴部 (Mouth)**: 触摸嘴部，后端可能返回特殊反应。
- **其他区域**: 触摸其他区域，后端可能返回默认反应。

**可视化配置** (设置面板 > 模型 > 触碸反应配置):
- 可以启用/禁用特定部位的触摸反应。
- 取消勾选可禁用某个部位的触摸事件发送。
- 每个模型可以有独立的触碸配置，自动持久化存储。
- 所有触摸反应的具体行为（动作、表情、消息）由后端Agent决定。

### 侧边栏聊天 (v1.3)

对话界面已由旧版的居中浮窗改为侧边栏设计：

1. **打开对话** - 点击顶栏图标或在托盘菜单选择“对话”。
2. **发送消息** - 在输入框输入文本并回车。
3. **对话历史** - 侧边栏支持查看与 AI 的历史对话内容。
4. **字幕显示** - 如果在设置中开启了“显示对话字幕”，在聊天框关闭时，底部仍会浮现简短的对话文字。5. **口型同步 (v1.5)** - 后端返回语音消息时，模型会根据音频频率自动进行口型同步动画，使对话更加自然生动。
### 窗口布局

应用窗口分为三个主要区域：

1. **顶栏（可拖拽）**
   - 左侧：连接状态指示器。
   - 右侧：切换模式、设置、最小化、关闭按钮。
   - **重要**：只有拖动顶栏才能移动整个窗口。

2. **主内容区域（模型渲染区）**
   - 显示 Live2D 模型。
   - 支持点击交互、视线跟随、鼠标滚轮缩放。
   - 模型会自动适应窗口大小的变化。

3. **侧滑对话栏**
   - 点击相关按钮滑出。
   - 集成对话记录沉浸式对话、输入框以及后续的多模态功能。

### 系统托盘功能

应用在生产模式下提供系统托盘支持：

1. **托盘图标** - 应用最小化或隐藏后会显示在系统托盘
2. **动态托盘菜单 (v1.5)** - 右键点击托盘图标（macOS单击）可以打开菜单：
   - **显示宠物/隐藏宠物** - 切换窗口可见性
   - **显示UI/隐藏UI** - 动态切换UI显示模式（纯模型或完整UI）
   - **打开对话/关闭对话** - 动态切换对话窗口
   - **置顶显示** - 切换窗口是否始终置顶
   - **设置** - 打开设置面板
   - **退出** - 完全退出应用
   - **注意**：菜单按钮文字会根据当前状态动态更新，例如当UI可见时显示"隐藏UI"，UI隐藏时显示"显示UI"
3. **双击托盘** - 双击托盘图标可快速显示/隐藏窗口
4. **关闭行为** - 点击窗口关闭按钮时，应用不会退出，而是隐藏到托盘

**自定义托盘图标**：
将图标文件放入 `assets/` 目录：
- `tray-icon-mac.png` - macOS 托盘图标（16×16或32×32，黑白单色）
- `tray-icon.png` - Windows/Linux 托盘图标（16×16或32×32）

### 窗口控制

- **顶栏拖动** - 拖动顶栏可移动整个窗口
- **窗口调整** - 所有模式下均支持调整窗口大小（最小 300×400）
- **最小化** - 点击顶栏右侧 `━` 按钮
- **关闭/隐藏** - 点击顶栏右侧 `✕` 按钮（生产模式下隐藏到托盘）
- **设置** - 点击顶栏右侧 `⚙️` 按钮
- **对话** - 点击底栏右下角 `💬` 按钮

### UI显示模式（v1.3）

应用支持两种显示模式：

**1. 完整UI模式**（默认）
   - 显示顶栏（状态+控制按钮）
   - 显示底栏（对话按钮）
   - 适合日常使用和操作

**2. 纯模型模式**
   - 隐藏所有UI元素
   - 仅显示 Live2D 模型
   - 更加沉浸，适合观赏

**切换方式：**
- 点击右下角悬浮的UI切换按钮（眼睛图标）
- 双击模型快速切换
- 使用系统托盘菜单 → "显示/隐藏UI"
- 调试命令：`window.app.toggleUI()`

**注意**：隐藏UI后，切换按钮会移至更低位置，保持可访问性。

### 窗口大小自适应

Live2D 模型会自动适应窗口大小：

1. **初始化** - 模型加载时自动居中并适配窗口
2. **窗口调整** - 调整窗口大小时，模型会自动重新缩放和居中
3. **自适应比例** - 模型占用约75%的窗口空间，确保合适的显示效果
4. **最小尺寸** - 窗口最小支持 300×400 像素

### 调试命令

打开开发者工具后，可以使用以下命令：

```javascript
// 发送消息
window.app.sendMessage('你好');

// 显示对话
window.app.showDialogue('测试对话', 3000);

// 播放动作
window.app.playMotion('TapBody', 0);

// 设置表情
window.app.setExpression('smile');

// 查看应用状态
window.app.getState();
```

### 安全系统调试

```typescript
// 查看授权状态
window.authManager.getAuthStatus();

// 手动登出
window.authManager.logout();

// 查看缓存模型
await window.modelCacheManager.getAllModelIds();

// 获取缓存大小
await window.modelCacheManager.getCacheSize();

// 清除缓存
await window.modelCacheManager.clearCache();
```

### 查看日志

打开开发者工具（F12），查看 Console 标签页的日志输出。

---

## ❓ 常见问题

### 登录失败

**问题**: 点击登录后提示"登录失败"

**解决方案**:
1. 检查后端服务器是否运行
2. 确认 `backendUrl` 配置正确
3. 检查用户名和密码是否正确
4. 查看浏览器控制台错误信息

### 模型加载失败

**问题**: 登录成功但模型无法加载

**解决方案**:
1. 检查后端模型 API 是否正常
2. 查看控制台的错误信息
3. 检查网络连接
4. 尝试清除缓存后重新加载

### 窗口无法拖拽

**问题**: 鼠标无法拖拽窗口
方案**:
```typescript
// 在浏览器控制台执行
await window.modelCacheManager.clearCache();
```

或手动清除浏览器数据：
1. 打开开发者工具
2. Application → Storage → Clear site data

---

## 🔄 更新

### 更新应用

```bash
# 拉取最新代码
git pull

# 安装依赖（如有新依赖）
npm install

# 重新编译
npm run compile
```

---

**注意**: 所有使用相关的说明都在本文档中，请勿创建新的使用文档。
模型无法加载或显示

**解决方案**:
1. 检查模型文件路径是否正确
2. 确认模型文件完整且格式正确
3. 查看控制台的错误信息
4. 尝试使用官方示例模型测试

### 后端连接失败

**问题**: 无法连接到后端服务器